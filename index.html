<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OsJa â€“ Matchmaking (ohne Backend)</title>
  <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; background:#0b0f14; color:#e6eef7; margin:0; }
    .wrap { max-width: 780px; margin: 6rem auto; padding: 0 1rem; }
    .card { background:#121822; border:1px solid #1f2937; border-radius:12px; padding:24px; }
    h1 { margin:0 0 8px; } .sub{color:#94a3b8;margin-top:0}
    .row{display:flex;gap:12px;margin:16px 0}
    input{flex:1;padding:12px;border-radius:10px;border:1px solid #334155;background:#0f1420;color:#e6eef7}
    button{padding:12px 16px;border-radius:10px;border:0;background:#2563eb;color:#fff;font-weight:600;cursor:pointer}
    button.secondary{background:#334155}
    .log{font-family:ui-monospace,monospace;background:#0d121a;border:1px solid #1f2937;border-radius:10px;padding:12px;max-height:300px;overflow:auto;white-space:pre-wrap}
    .ok{color:#86efac}.warn{color:#facc15}.err{color:#fca5a5}
    .badge{display:inline-block;padding:4px 8px;border-radius:12px;font-size:12px;background:#0b3b78}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>OsJa â€“ Spiel beitreten</h1>
      <p class="sub">Gib denselben Code ein wie dein Mitspieler. Bei zwei Leuten im selben Code startet das Match.</p>
      <div class="row">
        <input id="code" placeholder="z. B. osja-123" maxlength="32" />
        <button id="join">Beitreten</button>
        <button id="leave" class="secondary" disabled>Verlassen</button>
      </div>
      <div class="grid">
        <div><span class="badge" id="status">offline</span></div>
        <div style="text-align:right"><button id="ready" class="secondary" disabled>Bereit</button></div>
      </div>
      <h3>Log</h3>
      <div id="log" class="log"></div>
    </div>
  </div>

<script>
const logEl = document.getElementById("log");
const statusEl = document.getElementById("status");
const codeEl = document.getElementById("code");
const joinBtn = document.getElementById("join");
const leaveBtn = document.getElementById("leave");
const readyBtn = document.getElementById("ready");

function log(msg, cls=""){ const t=new Date().toLocaleTimeString();
  const d=document.createElement("div"); if(cls) d.classList.add(cls);
  d.textContent=`[${t}] ${msg}`; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; }

let ably = null, channel = null, myId = null, joined = false;

function setStatus(s){ statusEl.textContent = s; }
function setUiConnected(on){
  joinBtn.disabled = on; codeEl.disabled = on; leaveBtn.disabled = !on; readyBtn.disabled = !on;
  setStatus(on ? "verbunden" : "offline");
}

async function join() {
  const code = (codeEl.value||"").trim().toLowerCase();
  if (!code || code.length < 3) { log("Bitte Code mit mind. 3 Zeichen.", "warn"); return; }

  // 1) Ably verbinden
  ably = new Ably.Realtime.Promise({ key: "3wcmYg.8GQUGA:WaFbpDvdQSDdntaxL6mBMg72Om8OcOybipf-Sbs5eRc" });
  await new Promise((res, rej)=> ably.connection.once("connected", res));
  myId = ably.deviceId || Math.random().toString(36).slice(2);
  log("Mit Ably verbunden.", "ok");

  // 2) Channel beitreten (Code = Raumname)
  channel = ably.channels.get(`osja:${code}`);
  // Presence beitreten, damit wir wissen, wie viele drin sind
  await channel.presence.enter({ id: myId, ready:false });
  setUiConnected(true);
  joined = true;

  // 3) Beobachten wie viele Spieler da sind
  async function checkMatch() {
    const members = await channel.presence.get();
    const ids = members.map(m=>m.clientId || m.id);
    log(`Spieler im Raum: ${ids.join(", ")}`);
    if (members.length === 2) {
      log("ðŸŸ¢ Zwei Spieler gefunden â€“ Match kann starten!", "ok");
      channel.publish("matchStart", { players: ids });
    } else if (members.length > 2) {
      log("Raum ist voll â€“ bitte anderen Code verwenden.", "warn");
    }
  }

  channel.presence.subscribe(() => checkMatch());
  await checkMatch();

  // 4) Nachrichten
  channel.subscribe("matchStart", msg => {
    log("Signal: matchStart â†’ UI/Spiel ladenâ€¦", "ok");
    // Hier spÃ¤ter Spiel-UI initialisieren
  });

  readyBtn.onclick = () => {
    channel.publish("ready", { id: myId });
    log("â†’ Ich bin bereit.");
  };
  channel.subscribe("ready", msg => {
    log(`â† Spieler bereit: ${msg.data.id}`);
  });

  // Optional: Heartbeat/Debug
  setInterval(()=> channel.publish("ping", { t: Date.now() }), 15000);
  channel.subscribe("ping", ()=> {});
}

async function leave() {
  try {
    if (channel && joined) await channel.presence.leave();
    if (ably) ably.close();
  } catch {}
  joined = false; channel=null; ably=null; myId=null;
  log("Verlassen.", "warn"); setUiConnected(false);
}

joinBtn.addEventListener("click", join);
leaveBtn.addEventListener("click", leave);
setUiConnected(false);
</script>
</body>
</html>
