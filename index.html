<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OsJa – Auswahl (Step 1, Responsive + Scrollbox + Alphabetisch)</title>
  <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
  <style>
    :root {
      --bg:#0b0f14; --panel:#0f1420; --muted:#93a1b1; --line:#1f2937; --ok:#86efac; --warn:#facc15; --err:#fca5a5; --primary:#2563eb;
      --panel2:#121a2a; --chip:#0b3b78; --accent:#38bdf8;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;overflow:hidden;background:var(--bg);color:#e6eef7;font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif}
    .app{display:grid;grid-template-rows:auto 1fr;height:100vh}
    .topbar{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,#0b0f14 0%,rgba(11,15,20,.9) 100%);border-bottom:1px solid var(--line)}
    .topwrap{display:flex;gap:12px;align-items:center;justify-content:space-between;max-width:1200px;margin:0 auto;padding:10px 16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.3px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--primary);box-shadow:0 0 16px rgba(37,99,235,.6)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    input,button,select{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--panel);color:#e6eef7;font-size:14px}
    button{background:var(--primary);border:0;cursor:pointer;font-weight:600}
    button.secondary{background:#334155}
    button.ghost{background:transparent;border:1px dashed var(--line)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;background:var(--chip);border:1px solid var(--line)}
    .status{display:flex;align-items:center;gap:10px}

    .content{max-width:1200px;margin:0 auto;padding:12px 16px;height:100%;}
    .cols{display:grid;grid-template-columns:1.1fr .9fr;gap:14px;height:100%}
    .panel{background:var(--panel2);border:1px solid var(--line);border-radius:14px;padding:14px;min-height:0;display:flex;flex-direction:column}
    .panel h2{margin:0 0 6px;font-size:16px}
    .scroll{overflow:auto;min-height:0}

    .filters{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
    .checkbox{display:flex;align-items:center;gap:8px}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{font-size:11px;padding:3px 7px;border:1px solid var(--line);border-radius:999px;background:#0b3b78}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px}
    .card{background:#0d121a;border:1px solid var(--line);border-radius:12px;padding:10px;display:flex;gap:10px;align-items:flex-start}
    .card input[type="checkbox"]{margin-top:2px}
    .card .title{font-weight:700;font-size:14px}
    .card .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
    .card .desc{color:var(--muted);font-size:12px;margin-top:6px;display:none}
    .card .more{font-size:12px;color:var(--accent);cursor:pointer;margin-top:6px}

    .sideSection{display:grid;grid-template-rows:auto auto 1fr auto;gap:10px;height:100%}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#0f1420;font-size:12px}
    .list{margin:6px 0 0;padding-left:18px}

    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}

    /* Scrollboxen erzwingen, keine Body-Scrolls */
    #attacks.scroll{height:100%;max-height:calc(100vh - 220px);}
    #rangeleis{max-height:200px;overflow:auto}
    #log{max-height:140px;overflow:auto}

    /* Responsive */
    @media (max-width:960px){
      .cols{grid-template-columns:1fr}
      #attacks.scroll{max-height:40vh}
    }
    @media (max-width:640px){
      .grid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
      .topwrap{gap:8px}
      input,button{font-size:13px}
    }
  </style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="topwrap">
      <div class="brand"><span class="dot"></span> OsJa – Auswahl (Step 1)</div>
      <div class="toolbar">
        <input id="name" placeholder="Name (optional)" />
        <input id="code" placeholder="Code (z. B. osja-123)" />
        <button id="join">Beitreten</button>
        <button id="leave" class="secondary" disabled>Verlassen</button>
        <span class="badge" id="status">offline</span>
      </div>
      <div class="status">
        <span class="badge">Online: <span id="onlineCount">0</span>/2</span>
        <span class="badge">Du: <span id="meId">–</span></span>
        <span class="badge">Gegner: <span id="opId">–</span></span>
      </div>
    </div>
  </div>

  <div class="content">
    <div class="cols">

      <!-- LEFT: Attacken & Rangeleien Auswahl -->
      <section class="panel">
        <h2>Attacken auswählen <span class="pill" id="selCount">0 / 4</span> <span id="slotsInfo" class="chip" style="display:none">VA: +2 Slots</span></h2>
        <div class="filters">
          <input id="filter" placeholder="Attacken filtern…" style="flex:1" />
          <div class="checkbox"><input type="checkbox" id="onlyPassiv"/><label for="onlyPassiv">nur Passiv</label></div>
          <div class="checkbox"><input type="checkbox" id="onlyExtra"/><label for="onlyExtra">nur Extra</label></div>
          <div class="checkbox"><input type="checkbox" id="onlySchnell"/><label for="onlySchnell">nur Schnell</label></div>
          <button id="clearSel" class="ghost" disabled>Auswahl löschen</button>
        </div>
        <div id="attacks" class="grid scroll"></div>
      </section>

      <!-- RIGHT: Sidebar (Rangeleien, Ready, Logs, Passives) -->
      <aside class="panel sideSection">
        <div>
          <h2>Rangeleien <span class="pill" id="rangeleiCount">0 / 3</span></h2>
          <div class="filters">
            <input id="rangeleiFilter" placeholder="Rangeleien filtern…" style="flex:1" />
            <div class="chips" id="rangeleiHint"><span class="chip">Nur sichtbar, wenn <b>Immer vorbereitet</b> gewählt</span></div>
          </div>
          <div id="rangeleis" class="grid"></div>
        </div>
        <div class="row">
          <button id="readyBtn" disabled>Bereit (geheim) senden</button>
          <span>•</span>
          <div>Status: <b id="readyState">Warten…</b></div>
        </div>
        <div>
          <h2>Passiv-Reveal (nach beidseitigem Bereit)</h2>
          <div class="row">
            <div class="pill">Raum: <span id="roomInfo">–</span></div>
          </div>
          <div class="row" style="gap:20px">
            <div style="flex:1">
              <div class="small">Deine Passivattacken</div>
              <ol id="myPassives" class="list"></ol>
            </div>
            <div style="flex:1">
              <div class="small">Gegnerische Passivattacken</div>
              <ol id="oppPassives" class="list"></ol>
            </div>
          </div>
        </div>
        <div class="scroll">
          <h2>Log</h2>
          <div id="log" class="small"></div>
        </div>
      </aside>

    </div>
  </div>
</div>

<script>
// === KONFIG ===
const ABLY_KEY = "3wcmYg.8GQUGA:WaFbpDvdQSDdntaxL6mBMg72Om8OcOybipf-Sbs5eRc"; // Demo – öffentlich
const CHANNEL_NS = "osja";

// ==== Attacken-Daten (vollständig aus deinem PDF-Auszug, inkl. Tags & Kurzbeschreibung) ====
const ATTACKS = [
  {n:"Alles oder nichts", d:"Wähle eine deiner nicht Xmalig- und nicht Superattacken, führe sie aus und entferne sie dann. Am Ende des nächsten gegnerischen Zuges erneut ausführen.", t:["Einmalig"]},
  {n:"Alles wird gut!", d:"Belebe zwei Monster wieder.", t:["Einmalig"]},
  {n:"Bitte extra!", d:"Kontere eine Extra-Attacke.", t:["Dreimalig","Extra","Schnell"]},
  {n:"Feuerkobold", d:"Beschwöre ein 0/50 Monster mit: Bei Beschwörung 50 Schaden an ein Ziel.", t:[]},
  {n:"Feurige Waffen", d:"Erhalte in diesem Zug 10 Wut.", t:["Einmalig","Extra"]},
  {n:"Finale", d:"150 Schaden.", t:["Einmalig"]},
  {n:"Finales Ritual", d:"Verursacht die gesamte Menge an Schaden, die du in deinem eigenen Zug in diesem Spiel erhalten hast.", t:["Einmalig"]},
  {n:"Freund der Tiere", d:"Beschwöre ein 50/50 Monster.", t:[]},
  {n:"Gedankenkontrolle", d:"Gegner verrät seine Attacken. Wähle eine davon und setze sie ein (für ihn zählt der Verbrauch).", t:[]},
  {n:"Geheime Mission", d:"90 Schaden. Nicht konterbar.", t:[]},
  {n:"Gelbe Karte", d:"100 Schaden. Ist dies genau die 2. gespielte gelbe Karte (global), stattdessen 250 Schaden.", t:["Einmalig"]},
  {n:"Gleichheit", d:"Setze die Leben des Gegners auf deine aktuellen Leben.", t:[]},
  {n:"Hartes Training", d:"Erhalte 10 Wut.", t:[]},
  {n:"Heilung", d:"Heile 100 Leben.", t:["Super3"]},
  {n:"Immer vorbereitet", d:"Wähle vor Spielbeginn 3 Rangeleien und füge sie zu deinen Attacken hinzu.", t:["Passiv"]},
  {n:"Karnickel", d:"Beschwöre drei 0/10 Monster.", t:[]},
  {n:"Langsam, aber sicher", d:"10 × (Anzahl deiner erfolgreich ausgeführten Attacken) Schaden.", t:[]},
  {n:"Lebender Baum", d:"Beschwöre ein 0/150 Monster.", t:["Super2"]},
  {n:"Lebender Schild", d:"Wähle ein freundliches Monster. Verleihe ihm Spott.", t:[]},
  {n:"Lebenslehre", d:"Verleihe einem Monster eine deiner nicht Xmalig- und nicht Superattacken.", t:[]},
  {n:"Lehren", d:"Verleihe einem Charakter die Attacke: ‚100 Schaden‘.", t:[]},
  {n:"Letzter Wille", d:"5×20 Schaden.", t:["Einmalig"]},
  {n:"Letzte Chance", d:"Wenn du das nächste Mal tödlichen Schaden bekämst: negiere ihn und heile 50.", t:["Einmalig"]},
  {n:"Meister der Magie", d:"Verursacht 30 × (Anzahl ausgelöster Geheimnisse) Schaden.", t:[]},
  {n:"Metallschild", d:"Gegnerische Attacken machen 10 Schaden weniger.", t:["Passiv"]},
  {n:"Messerstich", d:"20 Schaden.", t:["Extra"]},
  {n:"Messerwürfe", d:"4×20 Schaden.", t:[]},
  {n:"Opfer", d:"Vernichte ein freundliches Monster. Alle befreundeten Charaktere erhalten seine Leben (maximale Extraleben).", t:[]},
  {n:"Prestige", d:"Erhalte alle in diesem Spiel ausgelösten Geheimnisse.", t:["Einmalig"]},
  {n:"Schnell", d:"Verleihe einer deiner Attacken in diesem Zug ‚schnell‘.", t:["Extra","Schnell"]},
  {n:"Schneller", d:"Verleihe einer Attacke ‚schnell‘ und ‚Diese Attacke kann keinem Gegner Schaden machen‘.", t:["Extra","Zweimalig","Schnell"]},
  {n:"Schneesturm", d:"Eigener Zug: Angreifer erleidet 10. Im Gegnerzug erfolgreiche Reaktionen: Gegner erleidet 10.", t:["Passiv"]},
  {n:"Schild und Schwert", d:"Verhindere 50 Schaden. Füge 50 Schaden zu.", t:["Schnell"]},
  {n:"Sicherer Schlag", d:"90 Schaden. Schaden nicht veränderbar.", t:[]},
  {n:"Sichere und geheime Mission", d:"60 Schaden. Nicht konterbar. Schaden nicht veränderbar.", t:["Schnell"]},
  {n:"Schwertschlag", d:"100 Schaden.", t:[]},
  {n:"Seelenschlag", d:"120 Schaden. Du erleidest 50 Selbstschaden.", t:[]},
  {n:"Spiegelschild", d:"Der nächste Gegner-Schaden trifft stattdessen den Gegner.", t:["Einmalig"]},
  {n:"Vorbereitung", d:"Deine nächste Schaden‑Attacke verursacht +30 Schaden.", t:[]},
  {n:"Wachsames Auge", d:"Gegner verrät seine Attacken; wähle eine, sie ist 2 Züge blockiert.", t:["Einmalig","Extra","Schnell"]},
  {n:"Waffen weg!", d:"Gegner führt alle seine Attacken aus; sie haben keinen Effekt (Xmalig/Super werden verbraucht).", t:["Einmalig","Extra"]},
  {n:"Wand", d:"Beschwöre ein 0/10 Monster mit Spott. Es kann nicht angreifen.", t:["Zweimalig"]},
  {n:"Wut", d:"Deine nächste Schaden‑Attacke verursacht +20 Schaden.", t:["Einmalig","Extra"]},
  {n:"Über dem Horizont", d:"Erhalte 120 Leben (erhöht maximale Leben).", t:["Einmalig","Schnell"]},
  {n:"Zauberkunststück", d:"Wähle eines von drei zufälligen Geheimnissen (Nr. 1–7).", t:[]},
  {n:"Zaubertrick", d:"Erhalte ein zufälliges Geheimnis.", t:[]},
  {n:"Zwei Wünsche", d:"Kontere eine Attacke.", t:["Zweimalig","Schnell"]},
  {n:"Zweite Chance", d:"Deine Einmalig‑Attacken sind Zweimalig.", t:["Passiv"]},
  {n:"Zyklus des Lebens", d:"Notiere/belebe Monster mit Geboren‑Marke gemäß Regel.", t:["Passiv"]}
];

const RANGELEIEN = [
  {n:"Doppelter Spott", d:"Verleihe beliebig vielen Gegnern Spott.", t:["Zweimalig","Extra"]},
  {n:"Einen Schritt voraus", d:"Kontere eine Attacke, die eine deiner Attacken kontert.", t:["Zweimalig","Extra","Schnell"]},
  {n:"Gedankenkontrolle", d:"Gegner setzt die Extra‑Attacke ein: ‚Füge dir selbst 60 Schaden zu‘.", t:[]},
  {n:"Geschwindigkeitstraining", d:"Verleihe einer Attacke Schnell.", t:[]},
  {n:"Grüne Karte", d:"In diesem Spiel wurde eine gelbe Karte weniger ausgespielt.", t:["Einmalig","Extra"]},
  {n:"Grüne Wiese", d:"Nicht‑eigener‑Zug‑Attacken machen 20 weniger Schaden.", t:["Passiv"]},
  {n:"Gutes Auge", d:"Übernimm die Kontrolle über zwei zufällige Geheimnisse.", t:["Einmalig"]},
  {n:"Heilung", d:"Heile 80 Leben.", t:["Super3"]},
  {n:"Neu geboren", d:"Setze die Leben eines Gegners auf 500.", t:["Einmalig","Extra"]},
  {n:"Ruhe", d:"Alle Attacken machen ab jetzt 30 weniger Schaden und geben 30 weniger Leben.", t:["Einmalig","Schnell"]},
  {n:"Sandsturm", d:"Füge allen Gegnern 50 Schaden zu.", t:[]},
  {n:"Schuss und Schlag", d:"Wähle x∈[3..7]. Gegner A: x×10, Gegner B: (10−x)×10.", t:[]},
  {n:"Schwertschlag", d:"80 Schaden.", t:[]},
  {n:"Wachsames Auge", d:"Gegner verrät dir seine Attacken.", t:["Einmalig","Extra"]},
  {n:"Wieder normal", d:"Zerstöre eine Passivattacke.", t:["Schnell"]}
];

// ====== UI refs
const $ = (id)=>document.getElementById(id);
const logEl=$("log"), statusEl=$("status"), roomInfoEl=$("roomInfo"), readyStateEl=$("readyState");
const nameEl=$("name"), codeEl=$("code"), joinBtn=$("join"), leaveBtn=$("leave");
const onlineCountEl=$("onlineCount"), meIdEl=$("meId"), opIdEl=$("opId");
const attacksWrap=$("attacks"), filterEl=$("filter"), selCountEl=$("selCount"), slotsInfoEl=$("slotsInfo");
const onlyPassivEl=$("onlyPassiv"), onlyExtraEl=$("onlyExtra"), onlySchnellEl=$("onlySchnell");
const readyBtn=$("readyBtn"), clearSelBtn=$("clearSel");
const rangeleisWrap=$("rangeleis"), rangeleiFilterEl=$("rangeleiFilter"), rangeleiCountEl=$("rangeleiCount"), rangeleiHint=$("rangeleiHint");
const oppPassivesEl=$("oppPassives"), myPassivesEl=$("myPassives");

// ====== State
let client=null, channel=null; let myId=null, roomCode=null;
let sel = new Set();            // ausgewählte Attacken (geheim)
let selRangelei = new Set();    // ausgewählte 3 Rangeleien (geheim)
let iAmReady=false, oppReady=false;
let oppPassives=[]; let myPassives=[]; let revealed=false;

function log(msg, cls=""){ const d=new Date().toLocaleTimeString(); const div=document.createElement('div'); if(cls)div.classList.add(cls); div.textContent=`[${d}] ${msg}`; logEl.appendChild(div); logEl.scrollTop = logEl.scrollHeight; }
const shortId=()=>Math.random().toString(36).slice(2,7);
const collator = new Intl.Collator('de', { sensitivity: 'base' });

function hasTag(a, tag){ return (a.t||[]).includes(tag); }
function isPassiveName(name){ const a=ATTACKS.find(x=>x.n===name); return a && hasTag(a,'Passiv'); }
function allowedSlots(){ return 4 + (sel.has('Immer vorbereitet') ? 0 : 0) + (sel.has('Verführerisches Angebot') ? 2 : 0); }
function needsRangelei(){ return sel.has('Immer vorbereitet'); }

function updateCounters(){
  selCountEl.textContent = `${sel.size} / ${allowedSlots()}`;
  slotsInfoEl.style.display = sel.has('Verführerisches Angebot') ? 'inline-flex' : 'none';
  rangeleiCountEl.textContent = `${selRangelei.size} / 3`;
  const okAttacks = sel.size === allowedSlots();
  const okRangelei = needsRangelei() ? selRangelei.size === 3 : true;
  readyBtn.disabled = !client || iAmReady || !(okAttacks && okRangelei);
  clearSelBtn.disabled = !client || iAmReady || (sel.size===0 && selRangelei.size===0);
  rangeleiHint.style.display = needsRangelei() ? 'none' : 'flex';
}

function renderAttackCard(a){
  const wrap=document.createElement('label'); wrap.className='card';
  const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=sel.has(a.n); cb.disabled=iAmReady;
  cb.addEventListener('change',()=>{
    if(cb.checked){
      if(selRangelei.has(a.n)) { cb.checked=false; log('Dieser Name ist bereits als Rangelei ausgewählt.', 'warn'); return; }
      if(sel.size >= allowedSlots()) { cb.checked=false; log('Attacken-Slots voll.', 'warn'); return; }
      sel.add(a.n);
    } else { sel.delete(a.n); if(a.n==='Immer vorbereitet'){ selRangelei.clear(); renderRangeleis(); } }
    updateCounters();
  });
  const box=document.createElement('div');
  const title=document.createElement('div'); title.className='title'; title.textContent=a.n;
  const tags=document.createElement('div'); tags.className='tags'; (a.t||[]).forEach(t=>{ const chip=document.createElement('span'); chip.className='chip'; chip.textContent=t; tags.appendChild(chip); });
  const desc=document.createElement('div'); desc.className='desc'; desc.textContent=a.d||'';
  const more=document.createElement('div'); more.className='more'; more.textContent='Was macht diese Attacke?';
  more.addEventListener('click',()=>{ desc.style.display = (desc.style.display==='block')? 'none':'block'; });
  box.appendChild(title); box.appendChild(tags); box.appendChild(more); box.appendChild(desc);
  wrap.appendChild(cb); wrap.appendChild(box);
  return wrap;
}

function renderAttacks(){
  const f=(filterEl.value||'').trim().toLowerCase();
  attacksWrap.innerHTML='';
  let list = ATTACKS.filter(a=>a.n.toLowerCase().includes(f));
  if($("onlyPassiv").checked) list=list.filter(a=>hasTag(a,'Passiv'));
  if($("onlyExtra").checked) list=list.filter(a=>hasTag(a,'Extra'));
  if($("onlySchnell").checked) list=list.filter(a=>hasTag(a,'Schnell'));
  list.sort((a,b)=>collator.compare(a.n,b.n));
  list.forEach(a=>attacksWrap.appendChild(renderAttackCard(a)));
  updateCounters();
}

function renderRangeleis(){
  const f=(rangeleiFilterEl.value||'').trim().toLowerCase();
  rangeleisWrap.innerHTML='';
  let list = RANGELEIEN.filter(a=>a.n.toLowerCase().includes(f));
  list.sort((a,b)=>collator.compare(a.n,b.n));
  list.forEach(a=>{
    const row=document.createElement('label'); row.className='card';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=selRangelei.has(a.n); cb.disabled=iAmReady || !needsRangelei();
    cb.addEventListener('change',()=>{
      if(!needsRangelei()){ cb.checked=false; log('Rangeleien nur mit "Immer vorbereitet".', 'warn'); return; }
      if(cb.checked){
        if(sel.has(a.n)) { cb.checked=false; log('Dieser Name ist bereits als Attacke ausgewählt.', 'warn'); return; }
        if(selRangelei.size>=3){ cb.checked=false; log('Du kannst genau 3 Rangeleien wählen.', 'warn'); return; }
        selRangelei.add(a.n);
      } else { selRangelei.delete(a.n); }
      updateCounters();
    });
    const box=document.createElement('div');
    const title=document.createElement('div'); title.className='title'; title.textContent=a.n;
    const tags=document.createElement('div'); tags.className='tags'; (a.t||[]).forEach(t=>{ const chip=document.createElement('span'); chip.className='chip'; chip.textContent=t; tags.appendChild(chip); });
    const desc=document.createElement('div'); desc.className='desc'; desc.textContent=a.d||'';
    const more=document.createElement('div'); more.className='more'; more.textContent='Was macht diese Rangelei?';
    more.addEventListener('click',()=>{ desc.style.display = (desc.style.display==='block')? 'none':'block'; });
    box.appendChild(title); box.appendChild(tags); box.appendChild(more); box.appendChild(desc);
    row.appendChild(cb); row.appendChild(box);
    rangeleisWrap.appendChild(row);
  });
  updateCounters();
}

function listPassivesFromSelection(set){ return [...set].filter(isPassiveName); }

async function maybeRevealPassives(){
  if(revealed) return;
  const res = await channel.presence.get();
  const members = Array.isArray(res)? res : (res?.items||[]);
  const bothReady = members.length===2 && members.every(m=>m.data && m.data.ready===true);
  if(!bothReady) return;
  revealed=true;
  myPassives = listPassivesFromSelection(sel);
  await channel.publish('passives_reveal', { playerId: myId, passives: myPassives });
  renderPassivesLists();
  log('Passivattacken offenbart.', 'ok');
}

function renderPassivesLists(){
  myPassivesEl.innerHTML=''; oppPassivesEl.innerHTML='';
  myPassives.forEach(n=>{ const li=document.createElement('li'); li.textContent=n; myPassivesEl.appendChild(li); });
  oppPassives.forEach(n=>{ const li=document.createElement('li'); li.textContent=n; oppPassivesEl.appendChild(li); });
}

function setConnected(on, code=''){
  $("status").textContent = on ? `verbunden: ${code}` : 'offline';
  joinBtn.disabled=on; codeEl.disabled=on; nameEl.disabled=on; leaveBtn.disabled=!on;
  updateCounters();
}

// ====== Ably / Lobby
let presencePoll=null;

async function refreshPresence(){
  if(!channel) return;
  try{
    const res = await channel.presence.get();
    const members = Array.isArray(res)? res : (res?.items||[]);
    onlineCountEl.textContent = String(members.length);
    const opp = members.find(m=>m.clientId!==myId);
    opIdEl.textContent = opp?.clientId || '–';
    oppReady = !!(opp && opp.data && opp.data.ready===true);
    readyStateEl.textContent = iAmReady && oppReady ? 'Beide bereit (Passiv-Reveal folgt)…' : iAmReady ? 'Du bist bereit. Warte auf Gegner…' : oppReady ? 'Gegner ist bereit. Wähle deine Auswahl…' : 'Warten…';
    await maybeRevealPassives();
  }catch(e){ log('Presence get Fehler: '+(e?.message||e),'err'); }
}

async function joinRoom(){
  roomCode=(codeEl.value||'').trim().toLowerCase(); if(!roomCode||roomCode.length<3){ log('Bitte Code (>=3) eingeben.','warn'); return; }
  const baseName=(nameEl.value||'').trim()||'player'; myId=`${baseName}-${shortId()}`; meIdEl.textContent=myId; roomInfoEl.textContent=`${CHANNEL_NS}:${roomCode}`;

  client = new Ably.Realtime.Promise({ key: ABLY_KEY, clientId: myId });
  client.connection.once('connected', async ()=>{
    log('Mit Ably verbunden.','ok'); setConnected(true, roomCode);
    channel = client.channels.get(`${CHANNEL_NS}:${roomCode}`);
    channel.presence.subscribe(['enter','update','leave'], refreshPresence);
    await channel.attach();
    await channel.presence.enter({ ready:false });
    await refreshPresence();
    if(presencePoll) clearInterval(presencePoll); presencePoll=setInterval(refreshPresence, 3000);
    channel.subscribe('passives_reveal', (msg)=>{
      if(msg?.data?.playerId===myId) return; // eigene ignorieren
      oppPassives = Array.isArray(msg.data.passives)? msg.data.passives : [];
      renderPassivesLists();
      log('Gegnerische Passivattacken eingetroffen.','ok');
    });
  });
  client.connection.on((s)=>{ if(['closed','failed','suspended','disconnected'].includes(s.current)){ setConnected(false); if(presencePoll){clearInterval(presencePoll); presencePoll=null;} } });
}

async function leaveRoom(){
  try{ if(channel) await channel.presence.leave(); }catch{}
  try{ if(client) client.connection.close(); }catch{}
  if(presencePoll){clearInterval(presencePoll); presencePoll=null;}
  setConnected(false);
  roomInfoEl.textContent='–'; onlineCountEl.textContent='0'; opIdEl.textContent='–'; readyStateEl.textContent='Warten…';
  iAmReady=false; oppReady=false; revealed=false; sel.clear(); selRangelei.clear(); myPassives=[]; oppPassives=[]; renderPassivesLists();
  renderAttacks(); renderRangeleis();
  log('Verlassen.'); client=null; channel=null; myId=null; roomCode=null;
}

// ====== UI Events
$("join").addEventListener('click', joinRoom);
$("leave").addEventListener('click', leaveRoom);
filterEl.addEventListener('input', renderAttacks);
rangeleiFilterEl.addEventListener('input', renderRangeleis);
$("onlyPassiv").addEventListener('change', renderAttacks);
$("onlyExtra").addEventListener('change', renderAttacks);
$("onlySchnell").addEventListener('change', renderAttacks);
$("clearSel").addEventListener('click', ()=>{ sel.clear(); selRangelei.clear(); renderAttacks(); renderRangeleis(); });

$("readyBtn").addEventListener('click', async ()=>{
  if(!client||!channel) return;
  const okAttacks = sel.size === allowedSlots();
  const okRangelei = needsRangelei()? selRangelei.size===3 : true;
  if(!(okAttacks && okRangelei)){ log('Bitte vollständig auswählen (Slots/Rangeleien).','warn'); return; }
  iAmReady=true;
  await channel.presence.update({ ready:true });
  document.querySelectorAll('#attacks input[type=checkbox]').forEach(cb=>cb.disabled=true);
  document.querySelectorAll('#rangeleis input[type=checkbox]').forEach(cb=>cb.disabled=true);
  $("readyBtn").disabled=true; $("clearSel").disabled=true;
  await refreshPresence();
});

// Initial
renderAttacks(); renderRangeleis(); updateCounters();

// Cleanup
window.addEventListener('beforeunload', ()=>{ try{ if(channel) channel.presence.leave(); }catch{} try{ if(client) client.connection.close(); }catch{} });
</script>
</body>
</html>
